const express = require('express');
const router = express.Router();
const User = require('../models/User');
const { generateToken } = require('../middleware/auth');
const { getCurrency } = require('../config/currencies');

// Register - Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Øª
router.post('/register', async (req, res) => {
  try {
    const { name, email, password, phone, currencyCode } = req.body;
    
    console.log('ğŸ“ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:', { name, email, phone, currencyCode });
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!name || !email || !password || !phone) {
      return res.status(400).json({ 
        success: false,
        message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©' 
      });
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const existingUser = await User.findOne({ email: email.toLowerCase() });
    if (existingUser) {
      return res.status(400).json({ 
        success: false,
        message: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„' 
      });
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø©
    const currencyInfo = getCurrency(currencyCode || 'SAR');
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const user = await User.create({
      name: name.trim(),
      email: email.toLowerCase().trim(),
      password,
      phone: phone.trim(),
      role: 'user',
      currency: {
        code: currencyInfo.code,
        symbol: currencyInfo.symbol,
        name: currencyInfo.name,
        nameAr: currencyInfo.nameAr
      },
      subscription: {
        plan: 'free',
        isActive: true,
        startDate: new Date(),
        endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
      }
    });
    
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ù…Ù„Ø©:', currencyInfo.nameAr);
    
    const token = generateToken(user._id);
    
    res.status(201).json({
      success: true,
      message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­',
      token,
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
        phone: user.phone,
        role: user.role,
        currency: user.currency,
        subscription: user.subscription
      }
    });
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', error);
    res.status(500).json({ 
      success: false,
      message: 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨',
      error: error.message 
    });
  }
});

// Login - Ù…Ø¹ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø©
router.post('/login', async (req, res) => {
  try {
    const { email, password } = req.body;

    const user = await User.findOne({ email });
    if (!user) {
      return res.status(401).json({ message: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©' });
    }

    const isMatch = await user.comparePassword(password);
    if (!isMatch) {
      return res.status(401).json({ message: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©' });
    }

    const token = generateToken(user._id);

    res.json({
      success: true,
      token,
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
        role: user.role,
        currency: user.currency, // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø©
        subscription: user.subscription
      }
    });
  } catch (error) {
    res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', error: error.message });
  }
});

const { protect } = require('../middleware/auth');

// Update user currency
router.patch('/update-currency', protect, async (req, res) => {
  try {
    const { currencyCode } = req.body;
    
    if (!currencyCode) {
      return res.status(400).json({ message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø©' });
    }
    
    const { getCurrency } = require('../config/currencies');
    const currencyInfo = getCurrency(currencyCode);
    
    const user = await User.findByIdAndUpdate(
      req.user._id,
      {
        currency: {
          code: currencyInfo.code,
          symbol: currencyInfo.symbol,
          name: currencyInfo.name,
          nameAr: currencyInfo.nameAr
        }
      },
      { new: true }
    ).select('-password');
    
    res.json({
      success: true,
      message: `ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰ ${currencyInfo.nameAr}`,
      currency: user.currency
    });
    
  } catch (error) {
    res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø©', error: error.message });
  }
});

// Get all currencies
router.get('/currencies', (req, res) => {
  const { getAllCurrencies } = require('../config/currencies');
  res.json({
    success: true,
    currencies: getAllCurrencies()
  });
});

// Change Password
router.post('/change-password', protect, async (req, res) => {
  try {
    const { currentPassword, newPassword } = req.body;
    
    const user = await User.findById(req.user._id);
    
    const isMatch = await user.comparePassword(currentPassword);
    if (!isMatch) {
      return res.status(401).json({ 
        success: false,
        message: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©' 
      });
    }
    
    user.password = newPassword;
    await user.save();
    
    res.json({
      success: true,
      message: 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­'
    });
  } catch (error) {
    res.status(500).json({ 
      success: false,
      message: 'Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
      error: error.message 
    });
  }
});

module.exports = router;